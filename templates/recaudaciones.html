{% extends "layout.html" %}
{% block title %}
Recaudaciones
{% endblock %}


{% block content %}

<div class="paginate" id="tabla-pc">
    <h2>Tabla de Cierre de Cajas</h2>




    <div style="display: grid; grid-template-columns:repeat(7,1fr);     align-items: center;">
        <p class="titles">ID</p>
        <p class="titles">USUARIO</p>
        <p class="titles">RETIROS</p>
        <p class="titles">TOTAL RECAUDADO</p>
        <p class="titles">FECHA Y HORA DE ABERTURA</p>
        <p class="titles">FECHA Y HORA DE CIERRE</p>
        <p class="titles">TOTAL EN CAJA AL CIERRE</p>

    </div>
    <div class="items">
        {%for row in caja_c %}

        <div class="tablaCajas">
            <p>{{row[0]}}</p>
            <p>{{row[1]}}</p>
            <p>{{row[2]}}</p>
            <p>{{row[3]}}</p>
            <p>{{row[4]}}</p>
            <p>{{row[5]}}</p>
            <p>{{row[6]}}</p>
        </div>
        {%endfor %}
    </div>
    <div class="pager">
        <a style="cursor: pointer;">
            <div class="firstPage">&laquo;</div>
            <div class="previousPage">&lsaquo;</div>
            <div class="pageNumbers"></div>
            <div class="nextPage">&rsaquo;</div>
            <div class="lastPage">&raquo;</div>
        </a>
    </div>
</div>

<h2 style="text-align: center;">Recaudaciones</h2>

<div class="tabla-s">

    <p id="r_diaria"><b>  RECAUDACION TOTAL DIA:</b></p>
    <p id="r_mensual"><b> RECAUDACION TOTAL MES:</b></p>
    <p id="r_anual"><b> RECAUDACION TOTAL AÑO:</b></p>
    <p> {{r_dia[0][0]}} $</p>


    <p>{{r_mes[0][0]}} $</p>


    <p>{{r_anio[0][0]}} $</p>




</div>
<div>
    <h2 style="text-align: center;">Busqueda por fecha: cierre de cajas y registros del camping.
    </h2>
    <p style="text-align: center;">Ingrese una fecha y un usario, del cual se pueda generar un informe sobre el estado
        del camping:</p>



    <form action="{{url_for('recaudaciones')}}" method="POST" class="date_f" id="fecha_de_cierre">
        <input type="hidden" name="csrf_token" value="{{csrf_token()}}">
        <div style="display: flex; gap:10px; align-items: center; justify-content: center; flex-wrap: wrap;">
            <h3>Ingrese una fecha:</h3>
            <input type="date" id="start" name="fechas" value="2022-01-01" min="2022-11-16" style="font-size: 16px;">
            <input id="pRV" list="usuarios" type="" name="usuario" placeholder="Ingrese el usuario"
                class="forms_field-input" required>
            <datalist id="usuarios">
                {%for i in u %}
                <option value="{{i[1]}}" />
                {%endfor%}
            </datalist>
            <input type="submit" value="=>GENERAR INFORME DE LA FECHA">


        </div>


    </form>
</div>
<p id="fecha_elegida" style="display: none;">{{fecha}}</p>
<div class="table__wrap">
    <table class="table">
        <thead class="table__header">
            <tr class="table__row">
                <th class="table__cell u-text-left">Fecha</th>
                <th class="table__cell u-text-left">Total recaudado en el día</th>
                <th class="table__cell u-text-right">Cantidad de ingresantes acampantes</th>
                <th class="table__cell u-text-right">Cantidad de ingresantes no acampantes</th>
                <th class="table__cell u-text-right">Cantidad de egresantes</th>
                <th class="table__cell u-text-right">Cajas abiertas</th>
                <th class="table__cell u-text-right">Cajas cerradas</th>
                <th class="table__cell u-text-right">Total de ingresantes</th>
                <th></th>
            </tr>
        </thead>

        <tbody>

            <tr class="table__row">
                <td class="table__account table__cell">
                    <span class="table__account-name">Fecha</span>
                    {{fecha}}

                </td>
                <td class="table__account table__cell">
                    <span class="table__account-name">Total recaudado en el día</span>
                    {% for i in r %}
                    {{i[0]}} $
                    {%endfor%}



                </td>
                <td class="table__balance table__cell u-text-right u-font-mono">
                    <span class="table__account-name">Cantidad de ingresantes acampantes</span>
                    {% for i in c_pa %}
                    {{i[0]}}
                    {% endfor%}

                </td>
                <td class="table__limit table__cell u-text-right u-font-mono">
                    <span class="table__account-name">Cantidad de ingresantes no acampantes</span>
                    {% for i in c_p %}
                    {{i[0]}}
                    {% endfor%}

                </td>
                <td class="table__available table__cell u-text-right u-font-mono">
                    <span class="table__account-name">Cantidad de egresantes</span>
                    {% for i in c_egresantes %}
                    {{i[0]}}
                    {% endfor%}

                </td>
                <td class="table__limit table__cell u-text-right u-font-mono">
                    <span class="table__account-name">Cajas abiertas</span>
                    {% for i in cajaa %}
                    {{i[0]}}
                    {% endfor%}

                </td>
                <td class="table__available table__cell u-text-right u-font-mono">
                    <span class="table__account-name">Cajas cerradas</span>
                    {% for i in cajac %}
                    {{i[0]}}
                    {% endfor%}



                </td>

                <td class="table__available table__cell u-text-right u-font-mono">
                    <span class="table__account-name">Total de ingresantes</span>

                    {% for i in t %}
                    {{i[0]}}
                    {% endfor%}



                </td>


            </tr>




        </tbody>

    </table>
</div>



<div id="customers" style="display: none;">


    <table id="tab_customers" class="table table-striped">
        <colgroup>
            <col width="20%">
            <col width="20%">
            <col width="20%">
            <col width="20%">
        </colgroup>
        <thead>
            <tr class='warning'>
                <th>U</th>
                <th>Pr</th>

                <th>P A</th>
                <th>P NA</th>

                <th>Al A</th>
                <th>Al NA</th>


                <th>Ap A</th>
                <th>Ap NA</th>

                <th>C A</th>
                <th>C C</th>

                <th>Recaudado</th>

            </tr>
        </thead>
        <tbody>

            <tr>
                <td>{{p}}</td>

                <td>
                    {% for i in ppp %}
                    {{i[0]}}
                    {% endfor%}
                </td>


                <td>

                    {% for i in a1 %}
                    {{i[0]}}
                    {% endfor%}

                </td>
                <td>
                    {% for i in b1 %}
                    {{i[0]}}
                    {% endfor%}
                </td>
                <td>
                    {% for i in c1 %}
                    {{i[0]}}
                    {% endfor%}
                </td>
                <td>
                    {% for i in d1 %}
                    {{i[0]}}
                    {% endfor%}
                </td>
                <td>
                    {% for i in e1 %}
                    {{i[0]}}
                    {% endfor%}
                </td>
                <td>
                    {% for i in f1 %}
                    {{i[0]}}
                    {% endfor%}
                </td>
                <td>
                    {% for i in cajaa %}
                    {{i[0]}}
                    {% endfor%}
                </td>
                <td>

                    {% for i in cajac %}
                    {{i[0]}}
                    {% endfor%}

                </td>
                <td>
                    {% for i in recaudado_u %}
                    {{i[0]}}
                    {% endfor%}
                </td>

            </tr>

        </tbody>
    </table>



    <table id="tab_customers-2" class="table table-striped">
        <colgroup>
            <col width="20%">
            <col width="20%">
            <col width="20%">
            <col width="20%">
        </colgroup>
        <thead>
            <tr class='warning'>
                <th>ID</th>
                <th>USUARIO</th>
                <th>RETIROS</th>
                <th>TOTAL RECAUDADO</th>
                <th>FECHA Y HORA DE ABERTURA</th>
                <th>FECHA Y HORA DE CIERRE</th>
                <th>TOTAL EN CAJA AL CIERRE</th>
        </thead>
        <tbody>
            {%for row in cajas_cerradas_por_f %}
            <tr>
                <td id="pdf_g">{{row[0]}}</td>
                <td>{{row[1]}}</td>
                <td>
                    {{row[2]}}
                </td>
                <td>
                    {{row[3]}}
                </td>
                <td>
                    {{row[4]}}
                </td>
                <td>
                    {{row[5]}}
                </td>
                <td>
                    {{row[6]}}
                </td>
            </tr>
            {%endfor %}
        </tbody>
    </table>

    <table id="tab_customers-3" class="table table-striped">
        <colgroup>
            <col width="20%">
            <col width="20%">
            <col width="20%">
            <col width="20%">
        </colgroup>
        <thead>
            <tr class='warning'>
                <th>PARTICULARES A</th>
                <th>PARTICULARES NA</th>

                <th>ALUMNOS A</th>
                <th>ALUMNOS NA</th>


                <th>APORTANTES A</th>
                <th>APORTANTES NA</th>

                <th>Total Ingresantes</th>

            </tr>
        </thead>
        <tbody>
            <tr>
                <td id="1">
                    {% for i in b2 %}
                    {{i[0]}}
                    {% endfor%}
                </td>
                <td id="2">
                    {% for i in b3 %}
                    {{i[0]}}
                    {% endfor%}
                </td>
                <td id="3">
                    {% for i in b4 %}
                    {{i[0]}}
                    {% endfor%}
                </td>
                <td id="4">
                    {% for i in b5 %}
                    {{i[0]}}
                    {% endfor%}
                </td>
                <td id="5">
                    {% for i in b6 %}
                    {{i[0]}}
                    {% endfor%}
                </td>
                <td id="6">
                    {% for i in b7 %}
                    {{i[0]}}
                    {% endfor%}
                </td>
                <td id="total">

                </td>
            </tr>

        </tbody>
    </table>

    <table id="tab_customers-4" class="table table-striped">
        <colgroup>
            <col width="20%">
            <col width="20%">
            <col width="20%">
            <col width="20%">
        </colgroup>
        <thead>
            <tr class='warning'>
                <th>PARTICULARES A</th>
                <th>PARTICULARES NA</th>

                <th>ALUMNOS A</th>
                <th>ALUMNOS NA</th>


                <th>APORTANTES A</th>
                <th>APORTANTES NA</th>



            </tr>
        </thead>
        <tbody>

            <tr>
                <td id="7">
                    0
                </td>
                <td id="8">
                    0
                </td>
                <td id="9">
                    0
                </td>
                <td id="10">
                    0
                </td>
                <td id="11">
                    0
                </td>
                <td id="12">
                    0
                </td>

            </tr>

        </tbody>
    </table>
    <p id="total-r">
        {% for i in r %}
        {{i[0]}}
        {%endfor%}
    </p>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
<script src="/static/pagination/jspdf.debug.js"></script>
<script src="https://unpkg.com/jspdf-autotable@3.5.22/dist/jspdf.plugin.autotable.js"></script>

<script>

    function GenerarPDF() {

        if ($('#pdf_g').length) {
            console.log("Existe tal consulta.")
            PDF();
        }

    }

    function PDF() {
        var a1 = new Array();
        var total = 0
            , particular_acampante_tot = 0    //b2 = particular_acampantes_tot
            , particular_acampantes_tot = 0 //b3 = particular_noacampantes_tot
            , alumno_acampante_tot = 0      //b4 = alumno_acampante_tot 
            , alumno_noacampante_tot = 0     //b5 =  alumno_noacampante_tot
            , aportante_acampante_tot = 0     //b6 =  aportante_acampante_tot 
            , aportante_noacampante_tot = 0      //b7 =  aportante_noacampante_tot 

        for (i = 0; i < 6; i++) {

            a1[i] = parseInt(document.getElementById((i + 1).toString()).innerHTML);


            if (a1[i] != 0) {

                console.log("valor de a1[i]:" + a1[i])
                // para cada a[i] calcular porcentaje del total.
                total += a1[i];

            }
        }

        particular_acampante_tot = (a1[0] / total) * 100  //b2 = particular_acampantes_tot
        particular_acampantes_tot = (a1[1] / total) * 100 //b3 = particular_noacampantes_tot
        alumno_acampante_tot = (a1[2] / total) * 100   //b4 = alumno_acampante_tot 
        alumno_noacampante_tot = (a1[3] / total) * 100  //b5 =  alumno_noacampante_tot
        aportante_acampante_tot = (a1[4] / total) * 100    //b6 =  aportante_acampante_tot 
        aportante_noacampante_tot = (a1[5] / total) * 100    //b7 =  aportante_noacampante_tot 

        document.getElementById("7").textContent = String(particular_acampante_tot).substring(0, 4) + "%";
        document.getElementById("8").textContent = String(particular_acampantes_tot).substring(0, 4) + "%";
        document.getElementById("9").textContent = String(alumno_acampante_tot).substring(0, 4) + "%";
        document.getElementById("10").textContent = String(alumno_noacampante_tot).substring(0, 4) + "%";
        document.getElementById("11").textContent = String(aportante_acampante_tot).substring(0, 4) + "%";
        document.getElementById("12").textContent = String(aportante_noacampante_tot).substring(0, 4) + "%";


        document.getElementById("total").textContent = total;

        const doc = new jsPDF()
        doc.setFontSize(12);
        doc.text(20, 7, "NA: No acampantes, A:Acampantes, C Ab: Cajas abiertas , C Cr : Cajas cerradas")
        doc.text(20, 12, "P: Particulares,  Al:  Alumnos , Ap : Aportantes, U: Usuario , Pr: Privilegio")
        doc.autoTable({ html: '#tab_customers' })
        doc.autoTable({ html: '#tab_customers-2' })
        doc.autoTable({ html: '#tab_customers-3' })
        doc.autoTable({ html: '#tab_customers-4' })

        let finalY = doc.lastAutoTable.finalY; // The y position on the page
        var total = document.getElementById("total-r").innerHTML;
        var fecha = document.getElementById("fecha_elegida").innerHTML;

        doc.text(20, 34.15, "Tabla de cierre de cajas:");
        doc.text(62.63, finalY + 1.15, total);
        doc.text(20, finalY - 47.5, "Total de ingresantes:")
        doc.text(20, finalY - 20.5, "Porcentaje de la cantidad de ingresantes:")
        doc.text(20, finalY + 11, "Total recaudado en el día:$")
        doc.text(127, finalY + 11, "Informe obtenido del: " + fecha)

        doc.save('Informe-' + fecha + '.pdf')



    }

    $(document).ready(function () {


        GenerarPDF();


    });

    function populateFields() {


        const querystring = window.location.search
        const params = new URLSearchParams(querystring)

        return params.get('r');

    }

    $(document).ready(function () {
        if (populateFields() == "diaria") {

            const element = document.getElementById("r_diaria");

            element.scrollIntoView();
            (document.getElementById("r_diaria")).style.border = "solid #0c352d 3px";
        }
        if (populateFields() == "mensual") {

            const element = document.getElementById("r_mensual");

            element.scrollIntoView();
            (document.getElementById("r_mensual")).style.border = "solid #0c352d 3px";

        }
        if (populateFields() == "anual") {

            const element = document.getElementById("r_anual");

            element.scrollIntoView();
            (document.getElementById("r_anual")).style.border = "solid #0c352d 3px";

        }
        if (populateFields() == "fecha_de_cierre") {

            const element = document.getElementById("fecha_de_cierre");

            element.scrollIntoView();
            (document.getElementById("fecha_de_cierre")).style.border = "solid #0c352d 3px";

        }
        if (populateFields() == "tabla_de_cajas") {

            const element = document.getElementById("tabla-pc");

            element.scrollIntoView();
            (document.getElementById("tabla-pc")).style.border = "solid #0c352d 3px";

        }



    });


    $(window).load(function () {
        getDate();
    });
    function getDate() {
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth() + 1;
        var yyyy = today.getFullYear();
        if (dd < 10) {
            dd = '0' + dd
        }
        if (mm < 10) {
            mm = '0' + mm
        }
        today = yyyy + '-' + mm + '-' + dd;
        document.getElementById("start").value = today;
        document.getElementById("start").setAttribute("max", today);

    }
</script>
{% endblock %}